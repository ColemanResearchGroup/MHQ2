---
title: "MHQ2-PHQ9 Current depression in UK Biobank"
author: "Rujia Wang"
date: "2023-11-09"
output: html_document
---

Configuration of global options 

```{r Setup, include=FALSE}
knitr::opts_chunk$set(
  echo = TRUE,
  comment = '',
  prompt = FALSE,
  cache = FALSE
  )
```

Clear global environment prior to initiation

```{r Clear global environment}
remove(list = ls())
```

```{r Load packages}
library(tidyverse)
library(dplyr)

```

### Read in data

```{r Read in data}
MHQ2<-readRDS("/scratch/prj/ukbiobank/UKB_MHQ2_Anonymised/MHQ2_Anonymous.rds")

```

### Rename variable names

```{r rename variable names}
new_colnames <- paste0("f.", gsub("-", ".", colnames(MHQ2)))
colnames(MHQ2) <- new_colnames

```

##### Current depression: PHQ-9 ######

A Two core symptoms: as least have one core symptom in past two weeks
f.29002.0.0: Little interest or pleasure (D1a) = More than half of the days (2) or Nearly every day (3)
OR
f.29003.0.0: Feeling down (D1b) = More than half of the days (2) or Nearly every day (3)

AND
B (number of symptoms) – Sum positive items >= 5
f.29002.0.0: Little interest or pleasure (D1a) = More than half of the days (2) or Nearly every day (3)
f.29003.0.0: Feeling down (D1b) = More than half of the days (2) or Nearly every day (3)
f.29004.0.0: Trouble sleeping (D1c) = More than half of the days (2) or Nearly every day (3)
f.29005.0.0: Feeling tired (D1d) = More than half of the days (2) or Nearly every day (3)
f.29006.0.0: Poor appetite(D1e)  = More than half of the days (2) or Nearly every day (3)
f.29007.0.0: Feeling guilt (D1f) = More than half of the days (2) or Nearly every day (3)
f.29008.0.0: Trouble concentrating (D1g) = More than half of the days (2) or Nearly every day (3)
f.29009.0.0: Moving slowly (D1h) = More than half of the days (2) or Nearly every day (3)
f.29010.0.0: Thoughts death (D1i) = Several days (1) More than half of the days (2) or Nearly every day (3)

```{r check whether participants have info for two core symptoms}

MHQ2 <- MHQ2 %>%
  mutate(
    PHQ9.No.Info = ifelse(
      (is.na(f.29002.0.0) | f.29002.0.0 < 0) & (is.na(f.29003.0.0) | f.29003.0.0 < 0),
      1,
      0
    )
  )

```

```{r screen participants who meet at least one core symptom}

MHQ2 <- MHQ2 %>%
  mutate(
    PHQ9.Screen = ifelse(
      ((!is.na(f.29002.0.0) & f.29002.0.0 >= 2) | (!is.na(f.29003.0.0) & f.29003.0.0 >= 2)) &
        (!is.na(PHQ9.No.Info) & PHQ9.No.Info == 0),
      1,
      0
    )
  )

```

```{r The number of items met by the participants}

### List of columns of PHQ9
columns_PHQ9.Items <- c(
  "f.29002.0.0", "f.29007.0.0", "f.29003.0.0", "f.29008.0.0", 
  "f.29004.0.0", "f.29009.0.0", "f.29005.0.0", "f.29006.0.0", "f.29010.0.0"
)

MHQ2$PHQ9.Items <- 0

for (col in columns_PHQ9.Items) {
  cutoff <- ifelse(col == "f.29010.0.0", 1, 2)
  MHQ2$PHQ9.Items <- with(MHQ2, ifelse(!is.na(get(col)) & get(col) >= cutoff, PHQ9.Items + 1, PHQ9.Items))
}

```

### PHQ-9 driven depression

```{r PHQ-9 driven depression}

MHQ2 <- MHQ2 %>%
  mutate(
    PHQ9.derived.depression = case_when(
      PHQ9.No.Info == 1 ~ NA_real_,
      (!is.na(PHQ9.Screen) & PHQ9.Screen == 1) & (!is.na(PHQ9.Items) & PHQ9.Items > 4) ~ 1,
      TRUE ~ 0
    )
  )

```

### PHQ-9 full score
Sum of 9 items: score ranged 0-27
Cut-offs used are: < 5 No depression; 5-15 Less severe depression; >15 More severe depression

```{r PHQ-9 full score}

MHQ2 <- MHQ2 %>%
  mutate(
    PHQ9.Severity = rowSums(across(c(f.29002.0.0, f.29007.0.0, f.29003.0.0, f.29008.0.0,
                                     f.29004.0.0, f.29009.0.0, f.29005.0.0, f.29010.0.0, f.29006.0.0),
                                   ~ ifelse(. < 0 | is.na(.), 0, .))
    )
  )

```

### Current Depression case and control

Current Depression cases (1 = cases): PHQ9 derived depression + CIDI-SF(L): Depressed.Ever
Current Depression controls (0 = controls): Scores negative on PHQ9 algorithm and below cut-off on PHQ9 full score (not derived from PHQ-9 depression AND PHQ-9 full score < 5)

#### FLAG: line 154: need to merge depression.ever.case variable from Lifetime depression script ####

```{r Current Depression}

MHQ2 <- MHQ2 %>%
  mutate(
    Depressed.Current = case_when(
      PHQ9.No.Info == 1 ~ NA_real_,
      PHQ9.derived.depression == 0 & (!is.na(PHQ9.Severity) & PHQ9.Severity < 5) ~ 0,
      depression.ever.case == 1 & (!is.na(PHQ9.Screen) & PHQ9.Screen == 1) & (!is.na(PHQ9.Items) & PHQ9.Items > 4) ~ 1, # need to merge depression.ever.case
      TRUE ~ NA_real_
    )
  )

```

### Current or subthreshold depression:

This category includes PHQ9 derived depression OR PHQ9 full score >= 5
and it plus controls for current depression will contain all of those who answered validly. 

```{r Current or subthreshold depression}

MHQ2 <- MHQ2 %>%
  mutate(
    Current.subthreshold.Depression = case_when(
      PHQ9.No.Info == 1 ~ NA_real_,
      (!is.na(PHQ9.Severity) & PHQ9.Severity >= 5) | PHQ9.derived.depression == 1 ~ 1,
      !is.na(Depressed.Current) & Depressed.Current == 0 ~ 0, 
      TRUE ~ NA_real_
    )
  )

```

### Current more severe depression: 

current depression with PHQ9 full score > 15

```{r Current more severe depression}

MHQ2 <- MHQ2 %>%
  mutate(
    Current.more.severe.depression = case_when(
      PHQ9.No.Info == 1 ~ NA_real_,
      Depressed.Current == 0 | (is.na(PHQ9.Severity) | PHQ9.Severity <= 15) ~ 0,
      Depressed.Current == 1 & !is.na(PHQ9.Severity) & PHQ9.Severity > 15 ~ 1,
      TRUE ~ NA_real_
    )
  )

```

### Medication helped

Any of the drugs the participant reported taking helped symptoms of depression (at least a little).
Case {depression ever} 
AND
f.29038.0.0-f.29038.0.2: Have you ever tried (D27) = Medication prescribed to you (2) 
AND
f.29039.0.0-f.29039.0.6: Have you ever tried these (D28) = at least one of: Citalopram (1), Fluoxetine (2), Sertraline (3), Paroxetine (4), 
f.29039.0.0-f.29039.0.6: Have you ever tried these (D28) = at least one of: Amitriptyline (5), Dosulepin (6), Other antidepressant (7) 
AND
For any of D28a to D28g: Has (selected medication) helped you to feel better (D28a-g) = “Yes, at least a little”
f.29040.0.0: Citalopram has helped feel better (1)
f.29041.0.0: Fluoxetine has helped feel better (1)
f.29042.0.0: Sertraline has helped feel better (1)
f.29043.0.0: Paroxetine has helped feel better (1)
f.29044.0.0: Amitriptyline has helped feel better (1)
f.29045.0.0: Dosulepin has helped feel better (1)
f.29046.0.0: Other antidepressants has helped feel better (1)

```{r Medication helped}

### check f.29038.0.0-f.29038.0.2: Have you ever tried (D27) = Medication prescribed to you (2) 

f.29038<-apply(MHQ2[,grep("f.29038.0", colnames(MHQ2))], 1, function(row) "2" %in% row) 
MHQ2$f.29038[c(f.29038)]<-1

### check f.29039.0.0-f.29039.0.6: Have you ever tried these (D28) = at least one of:Citalopram (1), Fluoxetine (2), Sertraline (3), Paroxetine (4), Amitriptyline (5), Dosulepin (6), Other antidepressant (7)

f.29039 <- apply(MHQ2[, grep("f.29039.0", colnames(MHQ2))], 1, function(row) any(c("1","2","3","4","5","6","7") %in% row))
MHQ2$f.29039[c(f.29039)] <- 1

#### FLAG: lines 234 and 236: need to merge depression.ever.case variable from Lifetime depression script ####

MHQ2 <- MHQ2 %>%
  mutate(
    Depressed.medication.helped = case_when(
      depression.ever.case == 1 & f.29038 == 1 & f.29039 == 1 &  # need to depression.ever.case
        (f.29040.0.0 == 1 | f.29041.0.0 == 1 | f.29042.0.0 == 1 | f.29043.0.0 == 1 | f.29044.0.0 == 1 | f.29045.0.0 == 1 | f.29046.0.0 == 1) ~ 1,
      depression.ever.case == 1 & f.29039 == 1 &
        ((f.29040.0.0 %in% c(0, -1) | f.29041.0.0 %in% c(0, -1) | f.29042.0.0 %in% c(0, -1) |
            f.29043.0.0 %in% c(0, -1) | f.29044.0.0 %in% c(0, -1) | f.29045.0.0 %in% c(0, -1) | f.29046.0.0 %in% c(0, -1))) ~ 0,
      TRUE ~ NA_real_
    )
  )
 
```

### Non-medication therapy helped

Any of the talking therapies or other therapeutic activities that participant reported participating in helped symptoms of depression (at least a little).
depression.ever.case=1 
AND
f.29047.0.0: Activities undertaken to treat depression (D29) = “Talking therapies, such as psychotherapy, counselling, group therapy or CBT” (1) 
OR 
f.29047.0.0: Activities undertaken to treat depression (D29) = “Other therapeutic activities such as mindfulness, yoga or art classes” (2)
AND
f.29048.0.0: Activities have helped (D29a) = “Yes, at least a little” (1)

```{r Non-medication therapy helped}

### check f.29047.0.0-f.29047.0.1: Activities undertaken to treat depression (D29)
f.29047 <- apply(MHQ2[, grep("f.29047.0", colnames(MHQ2))], 1, function(row) any(c("1","2") %in% row))
MHQ2$f.29047[c(f.29047)] <- 1

#### FLAG: lines 267 and 268: need to merge depression.ever.case variable from Lifetime depression script ####

MHQ2 <- MHQ2 %>%
  mutate(
    Depressed.non_medication.therapy.helped = case_when(
      depression.ever.case == 1 & f.29047 == 1 & f.29048.0.0 == 1 ~ 1, # need to merge Depressed.Ever
      depression.ever.case == 1 & f.29047 == 1 & (f.29048.0.0 == 0 | f.29048.0.0 == -1) ~ 0, 
      TRUE ~ NA_real_
    )
  )

```

## Save variables for export
```{r Save variables for export}
export_variables <- c("ID",
                      "PHQ9.No.Info",                                               
                      "PHQ9.Screen",
                      "PHQ9.Items",
                      "PHQ9.derived.depression",
                      "PHQ9.Severity",
                      "Depressed.Current",
                      "Current.subthreshold.Depression",
                      "Current.more.severe.depression",
                      "Depressed.medication.helped",
                      "Depressed.non_medication.therapy.helped"
                      )
```

## save data
```{r Write cleaned MHQ2 variables to a .rds file}
MHQ2 %>%
  select(all_of(export_variables)) %>%
  saveRDS(
    file = paste0(datapath,"MHQ2_PHQ9.rds")
    )
```


