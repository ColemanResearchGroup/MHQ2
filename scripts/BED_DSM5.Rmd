---
title: "UKB MHQ2 BED DSM-5"
author: "Helena Davies"
date: "2023-10-08"
output: html_document
---

```{r}
library("summarytools")
library("dplyr")
library("tidyverse")
library("data.table")
```

```{r read in data}
#dat <- readRDS("/Users/helenadavies/werk/UKB_MHQ2_algorithms/anon_data/MHQ2_Anonymous.rds")
dat <- readRDS("/Users/christopherhuebel/work/raw_data/MHQ2_Anonymous.rds")
```


*DSM-5 criteria*
1) Binge eating episodes at least once a week for three months. 
PLUS 
2) Either never weighed much less than other people expected OR Never had BMI indicating underweight OR 
Had periods when underweight, but binge eating never occurred when underweight 
PLUS 
3) Episodes feature loss of control at least once a week for at least three months 
PLUS 
4) Three or more of: 
Eat quickly 
Eat till uncomfortable 
Eat lots when not hungry 
Alone due to embarrassment 
Distress after eating 
PLUS 
5) Felt distressed about episodes of overeating 
PLUS 
6) Not associated with the recurrent use of inappropriate compensatory behaviour 


*Written algorithm*
Have you had recurrent episodes of excessive overeating or binge eating (EP6a) = 02 Yes, at least once a week 
AND 
What was the longest amount of time where you were overeating/binge eating at least once a week? (EP6b) = 03 At least three months 
 
AND 
NOT Case {Extended anorexia phenotype} 
OR 
BMI at low weight} > 18.55 kg/m2 
OR 
If you reported a time or times of low weight above, do/did you experience episodes of excessive overeating/binge eating during your time(s) of low weight? (EP6c) = 00 No, only at time(s) when I was NOT at low weight 
 
AND 
During your episodes of excessive overeating/binge eating, how often have you felt like you did not have control over your eating (e.g. not being able to stop eating or feeling compelled to eat)? (EP7) = 03 At least once a week for at least three months 
 
AND 
During these episodes of excessive overeating/binge eating, have you: 
(EP8) = At least 3 of: 
01 rapidly 
02 uncomfortably 
03 hungry 
04 embarassed 
05 disgusted 
 
AND 
Do/did you feel distressed about your episodes of excessive overeating/binge eating (EP9) =01 Yes 
 
AND 
During the time(s) when you were regularly overeating/binge eating, have you done any of the following as a way to control your body shape or weight? (EP10) = 00 None of the above

## Merge and freq

###29136 - Actions and feelings during periods of overeating/binge eating
1              Eaten much more rapidly than normal
2              Eaten until feeling uncomfortably full [data: 6690 vs 10920]
3              Eaten large amounts of food when not physically hungry [data: 2803 vs 9963]
4              Eaten alone because of feeling embarrassed by overeating [data 644 vs 5793]
5              Felt disgusted, depressed or very guilty afterward [706 vs 8341]
0              Done none of the above
-3            Prefer not to answer

```{r}
setDT(dat)
dat[,`29136_n3`:=`29136-0.0`==-3 | `29136-0.1`==-3 | `29136-0.2`==-3 | `29136-0.3`==-3 | `29136-0.4`==-3]
freq(dat$`29136_n3`)
dat[,`29136_0`:=`29136-0.0`==0 | `29136-0.1`==0 | `29136-0.2`==0 | `29136-0.3`==0 | `29136-0.4`==0]
freq(dat$`29136_0`)
dat[,`29136_1`:=`29136-0.0`==1 | `29136-0.1`==1 | `29136-0.2`==1 | `29136-0.3`==1 | `29136-0.4`==1]
freq(dat$`29136_1`)
dat[,`29136_2`:=`29136-0.0`==2 | `29136-0.1`==2 | `29136-0.2`==2 | `29136-0.3`==2 | `29136-0.4`==2]
freq(dat$`29136_2`)
dat[,`29136_3`:=`29136-0.0`==3 | `29136-0.1`==3 | `29136-0.2`==3 | `29136-0.3`==3 | `29136-0.4`==3]
freq(dat$`29136_3`)
dat[,`29136_4`:=`29136-0.0`==4 | `29136-0.1`==4 | `29136-0.2`==4 | `29136-0.3`==4 | `29136-0.4`==4]
freq(dat$`29136_4`)
dat[,`29136_5`:=`29136-0.0`==5 | `29136-0.1`==5 | `29136-0.2`==5 | `29136-0.3`==5 | `29136-0.4`==5]
freq(dat$`29136_5`)
dat<-as.data.frame(dat)

```

###29140 - Methods of controlling body shape or weight when overeating/binge eating

1              Made yourself vomit
2              Used laxatives (pills or liquids) [data 253 vs 500]
3              Used diuretics (water pills) [data 29 vs 145]
4              Used weight loss pills [191  vs 434]
5              Exercised excessively or felt distressed if unable to exercise [data 185 vs 441]
6              Fasted or not eaten for eight waking hours or more [data 285 vs 798]
7              Other methods to lose weight/stay at low weight [data 237 vs 622]
0              None of above
-3            Prefer not to answer

```{r}
setDT(dat)
dat[,`29140_n3`:=`29140-0.0`==-3 | `29140-0.1`==-3 | `29140-0.2`==-3 | `29140-0.3`==-3 | `29140-0.4`==-3 | `29140-0.5`==-3 | `29140-0.6`==-3]
freq(dat$`29140_n3`)
dat[,`29140_0`:=`29140-0.0`==0 | `29140-0.1`==0 | `29140-0.2`==0 | `29140-0.3`==0 | `29140-0.4`==0 | `29140-0.5`==0 | `29140-0.6`==0]
freq(dat$`29140_0`)
dat[,`29140_1`:=`29140-0.0`==1 | `29140-0.1`==1 | `29140-0.2`==1 | `29140-0.3`==1 | `29140-0.4`==1 | `29140-0.5`==1 | `29140-0.6`==1]
freq(dat$`29140_1`)
dat[,`29140_2`:=`29140-0.0`==2 | `29140-0.1`==2 | `29140-0.2`==2 | `29140-0.3`==2 | `29140-0.4`==2 | `29140-0.5`==2 | `29140-0.6`==2]
freq(dat$`29140_2`)
dat[,`29140_3`:=`29140-0.0`==3 | `29140-0.1`==3 | `29140-0.2`==3 | `29140-0.3`==3 | `29140-0.4`==3 | `29140-0.5`==3 | `29140-0.6`==3]
freq(dat$`29140_3`)
dat[,`29140_4`:=`29140-0.0`==4 | `29140-0.1`==4 | `29140-0.2`==4 | `29140-0.3`==4 | `29140-0.4`==4 | `29140-0.5`==4 | `29140-0.6`==4]
freq(dat$`29140_4`)
dat[,`29140_5`:=`29140-0.0`==5 | `29140-0.1`==5 | `29140-0.2`==5 | `29140-0.3`==5 | `29140-0.4`==5 | `29140-0.5`==5 | `29140-0.6`==5]
freq(dat$`29140_5`)
dat[,`29140_6`:=`29140-0.0`==6 | `29140-0.1`==6 | `29140-0.2`==6 | `29140-0.3`==6 | `29140-0.4`==6 | `29140-0.5`==6 | `29140-0.6`==6]
freq(dat$`29140_6`)
dat[,`29140_7`:=`29140-0.0`==7 | `29140-0.1`==7 | `29140-0.2`==7 | `29140-0.3`==7 | `29140-0.4`==7 | `29140-0.5`==7 | `29140-0.6`==7]
freq(dat$`29140_7`)
dat<-as.data.frame(dat)

```


# Pre-algorithm code
## Not during AN criteria
From the DSM5: "Does not occur exclusively during the course of anorexia nervosa"
```{r not during AN criteria}
dat <- dat %>%
  mutate(not_during_AN =
           case_when(
             # "If you reported a time or times of low weight above, do/did you experience episodes of excessive overeating/binge eating during your time(s) of low weight?"
             
             # "Only at time(s) when I was not at low weight"
            (
             `29134-0.0` == 2 |
               
            # "Both at times of low weight and when not at low weight"   
             `29134-0.0` == 1 |
              
            # "Not applicable, as did not have low weight"
             `29134-0.0` == -4
            ) |
              
            # "Only at time(s) of low weight"
             (
               `29134-0.0` == 0 &
                
            # No lifetime anorexia nervosa
              DSM_AN_algorithm == 0 &
              self_reported_AN == 0 
            # +++ add any other reports of AN
            ) ~ 1
           )
  )
```

## Create sumscore of binge eating behaviours (need at least 3 for DSM5 BED)
NB: Question was asked when Field 29132 ("Ever had recurrent episodes of excessive overeating or binge eating") was Yes.
```{r sumscore BE behaviours}
# Create numeric variables
dat <- dat %>%
  mutate(rapid_eating_numeric =
           case_when(`29136-0.0` == 1 |
                     `29136-0.1` == 1 |
                     `29136-0.2` == 1 | 
                     `29136-0.3` == 1 |
                     `29136-0.4` == 1 ~ 1,
                     
                     TRUE ~ 0
                     )
         ) %>%
  mutate(feeling_uncomf_full_numeric =
           case_when(`29136-0.0` == 2 |
                     `29136-0.1` == 2 |
                     `29136-0.2` == 2 | 
                     `29136-0.3` == 2 |
                     `29136-0.4` == 2 ~ 1,
                     
                     TRUE ~ 0
                     )
         ) %>%
  mutate(large_amounts_not_hungry_numeric =
           case_when(`29136-0.0` == 3 |
                     `29136-0.1` == 3 |
                     `29136-0.2` == 3 | 
                     `29136-0.3` == 3 |
                     `29136-0.4` == 3 ~ 1,
                     
                     TRUE ~ 0
                     )
         ) %>%
  mutate(eaten_alone_embarrassed_numeric =
           case_when(`29136-0.0` == 4 |
                     `29136-0.1` == 4 |
                     `29136-0.2` == 4 | 
                     `29136-0.3` == 4 |
                     `29136-0.4` == 4 ~ 1,
                     
                     TRUE ~ 0
                     )
         ) %>%
  mutate(disgusted_depressed_after_numeric =
           case_when(`29136-0.0` == 5 |
                     `29136-0.1` == 5 |
                     `29136-0.2` == 5 | 
                     `29136-0.3` == 5 |
                     `29136-0.4` == 5 ~ 1,
                     
                     TRUE ~ 0
                     )
         ) %>%
  mutate(no_BE_behaviours_numeric =
           case_when(`29136-0.0` == 0 |
                     `29136-0.1` == 0 |
                     `29136-0.2` == 0 | 
                     `29136-0.3` == 0 |
                     `29136-0.4` == 0 ~ 1,
                     
                     TRUE ~ 0
                     )
         ) %>%
  mutate(PNTA_BE_behaviours_numeric =
           case_when(`29136-0.0` == -3 |
                     `29136-0.1` == -3 |
                     `29136-0.2` == -3 | 
                     `29136-0.3` == -3 |
                     `29136-0.4` == -3 ~ 1,
                     
                     TRUE ~ 0
                     )
         )

# Check (expecting 6,312)
dat %>%
  freq(rapid_eating_numeric)

# Check (expecting 10,920)
dat %>%
  freq(feeling_uncomf_full_numeric)

# Check (expecting 9,963)
dat %>%
  freq(large_amounts_not_hungry_numeric)

# Check (expecting 5,798)
dat %>%
  freq(eaten_alone_embarrassed_numeric)

# Check (expecting 8,341)
dat %>%
  freq(disgusted_depressed_after_numeric)

# Check (expecting 2,429)
dat %>%
  freq(no_BE_behaviours_numeric)

# Check (expecting 97)
dat %>%
  freq(PNTA_BE_behaviours_numeric)


# Create sumscore
BE_behaviours_items <- dat %>% select(rapid_eating_numeric,
                                      feeling_uncomf_full_numeric,
                                      large_amounts_not_hungry_numeric,
                                      eaten_alone_embarrassed_numeric,
                                      disgusted_depressed_after_numeric)

dat <- dat %>%
    mutate(
        BE_behaviours_sumscore = rowSums(BE_behaviours_items,
                                         na.rm = TRUE)
    )

# Check (expecting maximum 5, minimum 0)
dat %>%
  descr(BE_behaviours_sumscore)
```
NB: This sumscore should only be used in the BED DSM5 algorithm, i.e., to indicate if participants have a score of 3 or above. A score of 0 is not informative because it includes people who did not answer the question or were not shown the question because of their answer to Field 29132.

# Algorithm
## Checks
For remaining questions in algorithm
```{r sanity checks}
# Excessive overeating or binge eating
# Expecting 3,338 for "Yes, at least once a week" (2)
dat %>%
  freq(`29132-0.0`)

# Loss of control
# Expecting 3,904 for "At least once a week for at least 3 months" (0)
dat %>%
  freq(`29135-0.0`)

# Duration of overeating/binge eating
# Expecting 2,479 for "At least 3 months" (0)
dat %>%
  freq(`29133-0.0`)

# Distress re. binge eating
# Expecting 10,960 for "Yes" (1)
dat %>%
  freq(`29137-0.0`)
              
# Compensatory behaviours to control for body shape or weight
# Expecting 1,124 for "None of the above" (0)
dat %>%
  freq(`29140-0.0`)
                
# Binge eating during low weight
# Expecting 2,767 for "Only at time(s) when I was not at low weight" (2)
# Expecting 1,352 for "Both at times of low weight and when not at low weight" (1)
# Expecting 241 for "Only at time(s) of low weight" (0)
# Expecting 15,049 for "Not applicable, as did not have low weight" (-4)
dat %>%
  freq(`29134-0.0`)
```

## BED DSM5 algorithm
```{r BED DSM5 algorithm}
dat <- dat %>%
  mutate(DSM5_BED_algorithm =
           case_when(
             
         # "Have you had recurrent episodes of excessive overeating or binge eating (i.e. eating significantly more than what most people eat in a similar period of time, for example, two hours)?" = "Yes, at least once a week" 
            `29132-0.0` == 2 &
        
        # "During your episodes of excessive overeating/binge eating, how often have you felt like you did not have control over your eating (e.g. not being able to stop eating or feeling compelled to eat)?" = "At least once a week for at least 3 months"  
           `29135-0.0` == 0 &
              
        # "What was the longest amount of time when you were overeating/binge eating at least once a week?" = "At least 3 months"
           `29133-0.0` == 0 &
          
        # "During these episodes of excessive overeating/binge eating, have you:" (Participant needs at least 3 of 5 binge-eating-related behaviours, sumscore calculated above)
          BE_behaviours_sumscore >= 3 &
          
        # "Do/did you feel distressed about your episodes of excessive overeating/binge eating?" = "Yes"
          `29137-0.0` == 1 &
          
        # "During the time(s) when you were regularly overeating/binge eating, have you done any of the following as a way to control your body shape or weight? (Select all that apply)?" = "None of the above"
          `29140-0.0` == 0 &

        # DSM5 criteria: "Does not occur exclusively during the course of anorexia nervosa" (calculated above)
          not_during_AN == 1 ~ 1
           )
  )

# Check
dat %>%
  freq(DSM5_BED_algorithm)
```

