---
title: "ED_AN_code"
version: 2.0
author: Zhaoying YU
output: html_document
date: "2023-10-07"
---

## Set-up

```{r}
library("dplyr")
library("tidyverse")
library("summarytools")
```

## Import data
```{r}
MHQ2 <-
readRDS("/Users/lilian/Desktop/MHQ2_Anonymous.rds")
```

##Sanity Checks
```{r}
#Period in life when was underweight
#Expecting 150,509 for 'No' (0)
MHQ2 %>%
  freq(`29120-0.0`)

#Did you feel fat?
#Expecting 16,570 for 'No' (0)
MHQ2 %>%
  freq(`29122-0.0`)

#Afraid of gaining weight or becoming fat
#Expecting 14,815 for 'No' (0)
MHQ2 %>%
  freq(`29123-0.0`)

#Thinking or feeling body larger than it is
#Expecting 15,810 for 'No' (0)
MHQ2 %>%
  freq(`29124-0.0`)

#Lowest weight during period when underweight
#Expecting Mean = 51.4476
mean(MHQ2[MHQ2$`29125-0.0`!=-1 & 
            MHQ2$`29125-0.0`!=-3 &
            MHQ2$`29125-0.0`!=0,]
            $`29125-0.0`, na.rm = TRUE)

#Low weight had/has negative consequences for health
#Expecting 14,186 for 'No' (0)
MHQ2 %>%
  freq(`29128-0.0`)

#Dependency of self-esteem on body shape or weight when at this low weight
#Expecting 11,759 for 'None at all or very little' (0)
MHQ2 %>%
  freq(`29129-0.0`)

#Methods of controlling body shape or weight when at this low weight
#Expecting 14,430 for 'None of above' (0)
MHQ2 %>%
  freq(`29130-0.0`)

#Ever had recurrent episodes of excessive overeating or binge eating
#Expecting 149,732 for 'No' (0)
MHQ2 %>%
  freq(`29132-0.0`)

#Experienced episodes of overeating/binge eating during time(s) of low weight
#Expecting 241 for 'Only at time(s) of low weight' (0)
MHQ2 %>%
  freq(`29134-0.0`)
```

## Algorithms
# BMI at low weight


Lowest weight during period when underweight [metric] /
((f.12144.1) Physical measures  Height [cm]/100)^2


> '29125-0.0'/('12144-1.0')^2

> I assumed the column name for height follows the same naming pattern as the other columns. However, I don't have the data for this variable, which I assume will be in another data subset. So not sure if the column name ('12144-1.0') is correct for height?

++OVERARCHING
Please check the column name for height and if the data for height contains code for 'not applicable'

```{r}
#BMI at low weight

#FOR TESTING: MHQ2$'12144-1.0'<-169.0
MHQ2 <- MHQ2 %>%
  mutate(BMI =
           case_when(is.na(`29125-0.0`) |
                     is.na(`12144-1.0`) |
                     `29125-0.0` %in% c(0, -1, -3) ~ NA,
                     TRUE ~ `29125-0.0` / (`12144-1.0`/100)^2)
        )
```
              
#Anorexia nervosa

BMI at low weight <= 18.55 kg/m2
>BMI <= 18.55

AND
(Did you feel fat? (EP2a/29122) = 1 Yes
>'29122-0.0' == 1

  OR
  During the time when you were at this low weight: Did you think or feel that your body or parts of your body were larger than they actually were? (EP2c/29124) = 1 Yes
  >'29124-0.0' == 1

  OR
  Did/do you ever think your low weight had/has negative consequences for your health? (EP4c/29128) = 0 No
  >'29128-0.0' == 0

  OR
  When you are/were at this low weight, how much is/was your self-esteem dependent on your body shape or weight? (EP4d/29129) = 2 A great deal OR 1 A moderate amount)
  >'29129-0.0' %in% c(1,2) 

AND
(During the time when you were at this low weight: Were you afraid that you might gain weight or become fat? (EP2b/29123) = 1 Yes
>'29123-0.0' == 1

  OR
  Have you done any of the following as a way to control your body shape or weight? (EP5/29130) = any of 1 to 7)
  >'29130-0.0' %in% c(1,2,3,4,5,6,7)



```{r}
#Anorexia nervosa
MHQ2 <- MHQ2 %>%
  mutate(AN =

           #{BMI at low weight} <= 18.55 kg/m2
                       BMI <= 18.55 &

           #(Did you feel fat? = 1 Yes
                       (`29122-0.0` == 1 |

           #During the time when you were at this low weight: Did you think or feel that your body or parts of your body were larger than they actually were? = 1 Yes
                        `29124-0.0` == 1 |

           #Did/do you ever think your low weight had/has negative consequences for your health? = 0 No
                        `29128-0.0` == 0 |

           #Was your self-esteem dependent on your body shape or weight = 2 A great deal OR 1 A moderate amount)
                        `29129-0.0` %in% c(1,2)) &

           #(Afraid that you might gain weight or become fat = 1 Yes
                       (`29124-0.0` == 1 |

           #Have you done any of the following as a way to control your body shape or weight? = any of 1 to 7)
                        `29130-0.0` %in% c(1,2,3,4,5,6,7))
            ~ 1,
         TRUE ~ 0
  ))

# #check results
# View(
#   MHQ2[,
#        c(
#          'Extended_AN',
#          'BMI',
#          '29122-0.0',
#          '29125-0.0',
#          '29128-0.0',
#          '29129-0.0',
#          '29124-0.0',
#          '29130-0.0',
#          'AN'
#        )
#        ]
# )
```

# Anorexia nervosa - binge/purge subtype


AND 
(Afraid that you might gain weight or become fat (EP2b) = 1 Yes
>'29124-0.0' == 1

AND 
(Have you had recurrent episodes of excessive overeating or binge eating (EP6c) = 2 Yes, ONLY at time(s) of low weight OR 1 Yes, BOTH at time(s) of low weight AND at time(s) when I was not at low weight)
>'29134-0.0' %in% c(1,2)

  OR 
  (Have you done any of the following as a way to control your body shape or weight (EP5) = 01 Made yourself vomit OR 02 Used laxatives (pills or liquids meant to stimulate bowel movement) OR 03 Used diuretics (water pills) OR 07 Used other methods to lose weight/stay at low weight)
  >'29130-0.0' %in% c(1, 2, 3, 7)

```{r}
#Anorexia nervosa - binge/purge subtype
MHQ2 <- MHQ2 %>%
  mutate(AN_binge_purge =
#Criteria A
           case_when(#BMI at low weight <= 18.55 kg/m2
                       BMI <= 18.55 &
#Criteria B
           #(Afraid that you might gain weight or become fat = 1 Yes
                       (`29124-0.0` == 1 |

          #Have you done any of the following as a way to control your body shape or weight? = any of 1 to 7)
                        `29130-0.0` %in% c(1,2,3,4,5,6,7)) &

#Criteria C
           #(Did you feel fat? = 1 Yes
                       (`29122-0.0` == 1 |

           #During the time when you were at this low weight: Did you think or feel that your body or parts of your body were larger than they actually were? = 1 Yes
                        `29124-0.0` == 1 |

           #Did/do you ever think your low weight had/has negative consequences for your health? = 0 No
                        `29128-0.0` == 0 |

           #Was your self-esteem dependent on your body shape or weight = 2 A great deal OR 1 A moderate amount)
                        `29129-0.0` %in% c(1,2)) &

#ANBP criteria
          #(Have you had recurrent episodes of excessive overeating or binge eating (EP6c) = 2 Yes, ONLY at time(s) of low weight OR 1 Yes, BOTH at time(s) of low weight AND at time(s) when I was not at low weight)
                       (`29134-0.0` %in% c(1,2) |

          #Have you done any of the following as a way to control your body shape or weight (EP5) = 1 Made yourself vomit OR 2 Used laxatives (pills or liquids meant to stimulate bowel movement) OR 3 Used diuretics (water pills) 
                        `29130-0.0` %in% c(1, 2, 3))
            ~ 1,
         TRUE ~ 0
  ))
# #check results
# View(
#   MHQ2[,
#        c(
#          'Extended_AN',
#          '29124-0.0',
#          '29134-0.0',
#          '29130-0.0',
#          'AN_binge_purge'
#        )
#        ]
# )
```

# Anorexia nervosa - restricting subtype
Case {anorexia nervosa} 
>Extended_AN == 1

AND 
EP2b= 01 Yes 
>'29123-0.0' == 1

AND 
Have you done any of the following as a way to control your body shape or weight (EP5) did not include!= 01 Made yourself vomit OR 02 Used laxatives OR 03 Used diuretics (water pills) OR 07 other methods 
>!'29130-0.0' %in% c(1, 2, 3, 7)

AND 
(Have you had recurrent episodes of excessive overeating or binge eating (EP6a) = 0 No
>'29132-0.0' == 0

  OR 
  Do/did you experience episodes of excessive overeating/binge eating during your time(s) of low weight (EP6c) = 00 No, only at time(s) when I was NOT at low weight)
  >'29134-0.0' == 0

AND 
Have you done any of the following as a way to control your body shape or weight (EP5) = 04 Used weight loss pills (over the counter or prescription) OR 05 Exercised excessively, felt compelled to exercise, felt uneasy or distressed if unable to exercise or prioritised exercise over your health or important activities OR 06 Fasted or not eaten for eight waking hours or more
>'29130-0.0' %in% c(4,5,6)

```{r}
#Anorexia nervosa - restricting subtype
MHQ2 <- MHQ2 %>%
  mutate(AN_restricting =
#Criteria A
           case_when(#BMI at low weight <= 18.55 kg/m2
                       BMI <= 18.55 &
#Criteria B
           #(Afraid that you might gain weight or become fat = 1 Yes
                       (`29124-0.0` == 1 |

          #Have you done any of the following as a way to control your body shape or weight? = 5 OR 6)
#Discuss with Helena: if should be 4, 5, 6 or 5, 6 only. What do we decide on weight loss pills
                        `29130-0.0` %in% c(5,6)) &

#Criteria C
           #(Did you feel fat? = 1 Yes
                       (`29122-0.0` == 1 |

           #During the time when you were at this low weight: Did you think or feel that your body or parts of your body were larger than they actually were? = 1 Yes
                        `29124-0.0` == 1 |

           #Did/do you ever think your low weight had/has negative consequences for your health? = 0 No
                        `29128-0.0` == 0 |

           #Was your self-esteem dependent on your body shape or weight = 2 A great deal OR 1 A moderate amount)
                        `29129-0.0` %in% c(1,2)) &

            ~ 1,
         TRUE ~ 0
  ))
# #check results
# View(
#   MHQ2[,
#        c(
#          'Extended_AN',
#          'BMI',
#          '29124-0.0',
#          '29132-0.0',
#          '29134-0.0',
#          '29130-0.0',
#          'AN_restrict'
#        )
#        ]
# )
```


